var ART=this,ART={};(function(){function sr(){_.get(window,"$Lan.code")!=="zh"&&_.extend(_.get(window,"$Lan.data"),{"还没上传贴图":"No pictures uploaded yet","文件格式不符合！允许的文件格式为":"File format not supported! The allowed file format is"})}function cr(n){switch(n){case 0:fi=1;ft=1;break;case 1:fi=1;ft=0;break;case 2:fi=0;ft=0}}function k(){i.length&&(p<h.length-1&&(h=h.slice(0,p+1)),h.push(ci()),h.length>30?h=h.slice(1):p++,it=0)}function lr(){return h.length<=0||p>=h.length-1?!1:(it?it=0:p++,ot(),!0)}function ar(){return h.length<=0||p<=0?!1:(it&&b=="table"?it=0:p--,ot(),!0)}function ot(){it&&(it=0);ki(h[p])}function vr(t){if(t){n=t;var i=_.cloneDeep(_.pick(n,["base","boxLayer","layers","selected"]));p<h.length-1&&(h=h.slice(0,p+1));h.push(i);h.length>30&&(h=h.slice(1))}}function ci(){return n?_.cloneDeep(_.pick(n,["base","boxLayer","layers","selected"])):null}function ki(t){if(!_.isUndefined(t)){n.base=_.cloneDeep(t.base);n.layers=_.cloneDeep(t.layers);n.boxLayer=_.cloneDeep(t.boxLayer);n.selected=_.cloneDeep(t.selected);var r=_.concat([n.boxLayer],n.layers);i=_.filter(r,function(t){return _.findIndex(n.selected,function(n){return n==f(t)})>=0});tt.observeData()}}function yr(i){t.toBeUpload=_.cloneDeep(_.pick(n,["base","boxLayer","layers","selected"]));i||(ni=1,p=0,h=[t.toBeUpload],ot())}function pr(){_.extend(t.data,t.toBeUpload);p=0;h=[t.toBeUpload];ot()}function wr(i,r){var h=hi.noBoxStruct,o=ci(),s;if(!o)return alert("还没上传贴图！");var f=et.texture3D=et.texture3D||document.createElement("CANVAS"),l=e,c=o.base[2];nt=1;w=ir();s=tr();f.width=s[0];f.height=s[1];t.draw(f,h,i);st(h,function(){for(var e,s=_.concat([n.boxLayer],n.layers),i=0;i<s.length;i++)e=s[i],e[1]*=c/u,e[2]*=c/u;ii(1);di(o);t.draw(l,1);st(0,function(){r&&r(f)})},0)}function br(n,r,f){var s=ci(),c=e,h=s.base[2],o;if(!s)return alert("还没上传贴图！");o=et.thum=et.thum||document.createElement("CANVAS");nt=r;w=ir();o.width=n;o.height=n;t.draw(o,1,1);st(0,function(){var n,r;for(yt(1),n=0;n<i.length;n++)r=i[n],r[1]*=h/u,r[2]*=h/u;ii(1);di(s);t.draw(c,1);st(0,function(){f&&f(o)})},0)}function di(n){ki(n);nt=n.base[1];w=n.base[0]}function kr(i,r,f){if(e){i=i||e.clientWidth;r=r||e.clientHeight;var o=u;nt=f||nt;e.width=i;e.height=r;t.draw(e,1);st(0,function(){for(var i,r=_.concat([n.boxLayer],n.layers),t=0;t<r.length;t++)i=r[t],i[1]*=o/u,i[2]*=o/u;ii(1)})}}function dr(){t.draw(e,1);st(0,function(){d()})}function gr(t,i,r,f){try{sr();s=[i.Width*y,i.Height*y];l=[r,f];u=nt*Math.min(l[0]/s[0],l[1]/s[1]);n={boxLayer:["BOX_"+i.BoxID,1,1,0,0,0,0,0,1],boxResx:{lines:t,boxJson:i},layers:[],layersResx:[],base:[w,nt,u],selected:[],isFaceB:0};dt=0}catch(e){}}function nu(t,i,f){if(_.isObject(e)&&ur(1),e=_.isString(t)?document.querySelector(t):t,e.getContext("2d"),l=[e.width,e.height],u=nt*Math.min(l[0]/s[0],l[1]/s[1]),r=new createjs.Stage(e),f){var o=new createjs.Shape;o.graphics.beginStroke("#fff").beginFill("#fff").drawRect(0,0,l[0],l[1]);o.name="background";r.addChild(o)}i||(yi(n.boxLayer),ct([n.boxLayer]),r.update());ur()}function tu(){var t=_.get(n,"boxResx.boxJson");t&&(s=[t.Width*y,t.Height*y],u=nt*Math.min(l[0]/s[0],l[1]/s[1]))}function gi(t,i){var u,e,r;t&&t.children.length!=0&&(t.scaleX=i[1],t.scaleY=i[2],t.children[0].children[0].rotation=i[3],u=(1-t.scaleX)*l[0]/2,e=(1-t.scaleY)*l[1]/2,t.regX=-i[4]/t.scaleX-u/t.scaleX,t.regY=-i[5]/t.scaleY-e/t.scaleY,t.name==f(n.boxLayer)?pi(t.children[0].children[0].children[0].graphics):_.find(n.selected,function(n){return n==t.name})&&(r=t.children[0].getChildByName("mask"),r&&nr(r,i)))}function li(){r.children&&_.each(r.children,function(n,t){var i,r,t;if(n.name!="background"&&n.children&&n.children.length>0&&(i=n.children[0].getChildByName("mask"),i))for(r=n.children[0].getChildIndex(i),i.visible=!1,t=r+1;t<=r+4;t++)n.children[0].children[t].visible=!1})}function nr(n,t){var l=y*u,e=t[1]*l,w=t[2]*l,a=8/e,i=50/e,r=-25/e,f=-25/w,o=n.regX*2,s=n.regY*2,v=si||"red";n.graphics.clear();n.graphics.setStrokeStyle(a).beginStroke(v).rect(0,0,o,s).closePath();var k=[["lt",r,f],["lb",r,s+f],["rt",o+r,f],["rb",o+r,s+f]],p=n.parent,h=!0;c>0&&b=="table"&&(h=!1);_.each(k,function(r){var f="dot_"+r[0],e=r[1],o=r[2],u=p.getChildByName(f);u==null&&(u=new createjs.Shape,u.name=f,u.scale=n.scale,u.regX=n.regX,u.regY=n.regY,u.setBounds(e,o,i,i),p.addChild(u));u.graphics.clear();u.graphics.setStrokeStyle(a).beginFill(v).drawRect(e,o,i,i).endFill();u.rotation=t[3];u.visible=h});n.rotation=t[3];n.visible=h}function d(n){li();n=n||i;for(var t=0;t<n.length;t++)gi(r.getChildByName(f(n[t])),n[t]);(r.update(),c>0&&b=="table")||tt.observeData()}function ti(){var u,f,r,t;if(g&&i.length&&(u=1+(o[1]-v[1]),f=1+(o[2]-v[2]),i[0][0]!=n.boxLayer[0]||!(i[0][1]*u<bi[0]||i[0][1]*u>bi[1]))){for(r=0;r<i.length;r++)for(i[r][1]*=u,i[r][2]*=f,t=3;t<6;t++)switch(t){case 4:i[r][t]=(bt[r][t]+(o[t]-v[t]))*u;break;case 5:i[r][t]=(bt[r][t]+(o[t]-v[t]))*f;break;default:i[r][t]=bt[r][t]+(o[t]-v[t])}d(i)}}function ai(n,t){if(g&&i.length){if(t&&rt(1),!i.length)return t&&rt(0);kt();_.forEach(n,function(n,t){switch(t){case"1":case"2":o[t]+n>0&&n>-1&&(o[t]+=n);break;default:o[t]+=n}});ti()}}function f(n){return n[0]+"_"+n[8]}function iu(t){return _.includes(n.selected,f(t))}function vt(i){var u,r,e,o;for(kt(),u=0;u<n.layers.length;u++)r=n.layers[u],i?(e=r[1]/n.boxLayer[1],o=r[2]/n.boxLayer[2],r[4]=r[4]/n.boxLayer[1]-n.boxLayer[4]/n.boxLayer[1],r[5]=r[5]/n.boxLayer[2]-n.boxLayer[5]/n.boxLayer[2],r[1]=e,r[2]=o,r[3]=r[3]-n.boxLayer[3]):_.find(t.data.selected,function(n){return n==f(r)})&&(r[1]=n.boxLayer[1],r[2]=n.boxLayer[2],r[4]=n.boxLayer[4],r[5]=n.boxLayer[5]);i&&(n.boxLayer[1]=n.boxLayer[2]=1,n.boxLayer[3]=0,n.boxLayer[4]=n.boxLayer[5]=0)}function ii(t){if(vt(t),t){var i=_.concat([n.boxLayer],n.layers);d(i)}else d()}function rt(t){t?wi=i:(i=wi,n.selected=_.transform(i,function(n,t){n.push(f(t))}))}function tr(){var n=t.maxSize;sc=1;var i=s[0]*sc,r=s[1]*sc,u=Math.max(i,r);return u<=n?[i,r]:[n*i/u,n*r/u]}function ir(){var t=n.boxResx.boxJson,u=w,i,r;return w=300,y=w/25.4,s=[t.Width*y,t.Height*y],i=tr(),r=i[0]*25.4/t.Width,w=u,y=w/25.4,s=[t.Width*y,t.Height*y],r}function st(i,u,e){(_.isUndefined(e)||e==null)&&(e=ht);u=u||Cm.EMPTY_FUN;var o=0,s=function(){o++;o==n.layers.length&&(i||(yi(n.boxLayer),d([n.boxLayer])),u())},h=function(n){var t=new createjs.Container,i;r.addChild(t);t.name=f(n);i=vi(n[0]);i&&(ri({container:t,layerData:n,img:i,isDrawMask:e}),s())};_.forEach(n.layers,function(n){h(n)});n.layers.length||(i||yi(n.boxLayer),u());t.stage.update()}function yt(t){selectType=t?"table":"pics";i=t?_.concat([n.boxLayer],n.layers):n.layers;n.selected=_.transform(i,function(n,t){n.push(f(t))})}function ct(t){if(t){var r=_.concat([n.boxLayer],n.layers),u=_.chain(r).intersectionBy(t,f).value();i=[];n.selected=[];_.forEach(u,function(t){i.push(t);n.selected.push(f(t))})}else i=[],n.selected=[]}function ru(t){var r=[],u;_.isUndefined(t)||_.each(t,function(t){n.layers[t]&&r.push(n.layers[t])});u=_.difference(n.layers,r);n.layers=[];i=_.difference(i,r);_.each(u,function(t,r){var u=_.find(i,function(n){return n[0]==t[0]});u&&(u[8]=r);t[8]=r;n.layers.push(t)});n.selected=_.transform(i,function(n,t){n.push(f(t))});n.selected.length==0&&(n.selected=[]);i.length==0&&(i=[]);dt=n.layers.length;k()}function uu(t,r){var u=_.find(n.layers,function(n){return n[8]==t}),e;r==0?u[8]=-1:t>r?u[8]=(r*2-1)/2:t<r&&(u[8]=(r*2+1)/2);e=_.cloneDeep(u[8]);n.selected=[f(u)];n.layers=_.sortBy(n.layers,function(n){return n[8]});_.each(n.layers,function(t,r){t[8]==e?(t[8]=r,n.selected=[f(t)],i=[t]):t[8]=r});k();ot()}function fu(t,r){var e=i[0][0],u=_.find(n.layers,function(n){return n[8]==t});r==0?u[8]=-1:t>r?u[8]=(r*2-1)/2:t<r&&(u[8]=(r*2+1)/2);n.layers=_.sortBy(n.layers,function(n){return n[8]});_.each(n.layers,function(t,r){t[0]==e?(t[8]=r,n.selected=[f(t)],i=[t]):t[8]=r});k();ot()}function eu(n){var t;return window.createObjectURL!=undefined?t=window.createObjectURL(n):window.URL!=undefined?t=window.URL.createObjectURL(n):window.webkitURL!=undefined&&(t=window.webkitURL.createObjectURL(n)),t}function ou(t,i){var u=function(){var e=this.files[0],o=eu(e),h=t[0]=e.name.toLowerCase(),a=h.lastIndexOf("."),s=h.substr(a+1),c,u,l;if(hr.indexOf(s.toLowerCase())==-1){alert("文件格式不符合！允许的文件格式为".exLang()+' ["jpg", "jpeg", "pdf", "png", "tif","gif"]');return}ft&&n.layers.length&&(c=r.getChildByName(f(n.layers[0])),n.layers=[],r.removeChild(c));n.layers.push(t);u=new createjs.Container;r.addChild(u);r.setChildIndex(r.children[r.children.length-1],r.children.length-2);li();ft&&su(e);_.find(n.layersResx,function(n){return n.name==t[0]})&&(s=t[0].split(".")[1],l=(new Date).getTime(),t[0]=t[0].substring(0,t[0].length-4)+"_"+l+"."+s);_.endsWith(t[0],".pdf")?au(t,o,function(n){u.name=f(t);ri({container:u,layerData:t,img:n,isDrawMask:ht});ct([t]);k();i&&i();tt.image_mousedown();tt.observeData()}):_.endsWith(t[0],".tif")||_.endsWith(t[0],".tiff")?vu(t,o,function(n){u.name=f(t);ri({container:u,layerData:t,img:n,isDrawMask:ht});ct([t]);k();i&&i();tt.image_mousedown();tt.observeData()}):lu({url:o,container:u,layerData:t,isDrawMask:ht},i)};pt=document.createElement("input");pt.addEventListener("change",u,!1);pt.type="file";pt.accept="image/*,application/pdf";pt.click()}function su(n){var i=this,t=new FileReader;t.readAsBinaryString(n);t.onload=function(){et.fileName=n.name;et.fileBinaryString=this.result}}function vi(n){var i=_.find(t.data.layersResx,function(t){return t.name==n}),r=_.get(i,"db");return r.$Canvas?_.get(i,"db.$Canvas"):r}function hu(i,r){function o(n){var i=_.find(t.data.layers,function(t){return t[8]==n}),r=vi(_.get(i,"0"));r&&(i[1]=Math.abs(Math.sin(Math.PI*i[3]/180))==1?i[2]=e/r.height:i[2]=e/r.width,u.push(i))}var u,e,h;(r=r||0,i=i||0,t.data.layers.length!==0)&&(u=[],e=gt*2*y+s[0],vt(1),vt(0),i==0?_.each(t.selected,function(t){f(t)!=f(n.boxLayer)&&o(t[8])}):o(i),t.select(u),h=_.concat([n.boxLayer],n.layers),r||t.render(h),k())}function cu(i){function e(n){var i=_.find(t.data.layers,function(t){return t[8]==n}),f=vi(_.get(i,"0"));f&&(i[1]=Math.abs(Math.sin(Math.PI*i[3]/180))==1?i[2]=u/f.width:i[2]=u/f.height,r.push(i))}var r,u,o;(i=i||0,t.data.layers.length!==0)&&(r=[],u=gt*2*y+s[1],vt(1),vt(0),i==0?_.each(t.selected,function(t){f(t)!=f(n.boxLayer)&&e(t[8])}):e(i),t.select(r),o=_.concat([n.boxLayer],n.layers),t.render(o),k())}function lu(t,i){var e=t.container,u=t.layerData,o=t.isDrawMask,r;e.name=f(u);r=new Image;r.src=t.url;r.onload=function(){n.layersResx.push({name:u[0],db:r});ri({container:e,layerData:u,img:r,isDrawMask:o});ct([u]);k();i&&i();tt.image_mousedown();tt.observeData()}}function au(i,r,u){var f=i[0],e={url:r,cMapUrl:"https://unpkg.com/pdfjs-dist@2.0.943/cmaps/",cMapPacked:!0};pdfjsLib.getDocument(e).then(function(r){r.getPage(1).then(function(r){var s=document.createElement("CANVAS"),h,p,k;r.$Canvas=s;h={name:f,db:r,fixS:1};n.layersResx.push(h);var c=r.getViewport(1,1),l=300/72,a=300/72,v=1,w=1,e=v=c.width*l,o=w=c.height*a,d=t.maxSize,y=Math.pow(d,2),g=e*o,b=1;y<g&&(e=Math.sqrt(e*y/o),o=y/e,h.fixS=b=v/e,i[1]=i[2]=b,l*=e/v,a*=o/w);s.width=e;s.height=o;p=s.getContext("2d");k={transform:[l,0,0,a,0,0],canvasContext:p,viewport:c};r.render(k).promise.then(function(){u(p.canvas)})})})}function ri(t){var v=t.container,e=t.layerData,y=t.isDrawMask,o=t.img,c=o.width,a=o.height,i=new createjs.Container,s,f,h;i.name="layer";v.addChild(i);s=new createjs.Bitmap(o);s.scale=u;i.addChild(s);s.regX=o.width/2;s.regY=o.height/2;i.regX=-s.regX*e[1]-(l[0]-o.width*e[1])/2;i.regY=-s.regY*e[1]-(l[1]-o.height*e[2])/2;y&&(f=new createjs.Shape,f.name="mouseMask",f.alpha=.2,i.addChild(f),h=new createjs.Shape,h.name="mask",h.scale=u,h.regX=c/2,h.regY=a/2,i.addChild(h),nr(h,e),i.handleOver=i.on("mouseover",function(){var n=i.children[0].rotation;f.graphics.clear();f.graphics.beginFill("grey").drawRect(-(c/2)*u,-(a/2)*u,c*u,a*u);f.rotation=n;r.update()}),i.handleOut=i.on("mouseout",function(){f.graphics.clear();r.update()}),f.handleDown=f.on("mousedown",function(t){(t.stopPropagation(),oi=="contain"&&n.selected.length>1)||(f.graphics.clear(),li(),ct([e]),d())}));gi(v,e);r.update()}function vu(t,i,r){var u=t[0];Cm.xmlReq2({url:i,responseType:"arraybuffer",success:t=>{var f=new window.Tiff({buffer:t}),i=f.toCanvas(),e={name:u,db:i};n.layersResx.push(e);r&&r(i)}})}function yu(){var n=navigator.userAgent,t=n.match(/(iPad).*OS\s([\d_]+)/),i=!t&&n.match(/(iPhone\sOS)\s([\d_]+)/),r=n.match(/(Android)\s+([\d.]+)/);return i||r}function yi(n){var h=new createjs.Container,o=new createjs.Container,e=new createjs.Container,v,i;wt=new createjs.Container;h.name=f(n);r.addChild(h);h.addChild(o);o.addChild(e);e.regX=s[0]*u/2;e.regY=s[1]*u/2;o.regX=-e.regX-(l[0]-s[0]*u)/2;o.regY=-e.regY-(l[1]-s[1]*u)/2;v=new createjs.Shape;e.addChild(v);e.addChild(wt);i=new createjs.Container;e.addChild(i);r.$Rect=i;i.mouseover_rect=i.on("mouseover",function(n){n.stopPropagation();var t=n.target,i=t.$Sign;i&&(a.alived=i.idx,t.alpha=.2,r.update())});i.mouseout_rect=i.on("mouseout",function(n){n.stopPropagation();var t=n.target,i=t.$Sign;i&&(a.selected!==i.idx&&(a.alived=-1,t.alpha=.01),r.update())});i.mousedown_rect=i.on("mousedown",function(n){n.stopPropagation();var i=n.target,t=function(){var n=i.$Sign;n&&(a.alived=n.idx,rr(a.alived))};Cm.isPC()?t():setTimeout(function(){c==0&&t()},180)});t.stage.enableMouseOver(_.invoke(window,"Cm.isPC")?60:10);pi(v.graphics)}function pi(t){function h(t){return n.isFaceB&&(t.x=ot*2-t.x),{x:t.x,y:t.y}}function st(t){return n.isFaceB&&(t=t<=1?1-t:3-t),t}function pt(){for(var p,w,c,u,f,l,a,s=0,v=g.length;s<v;s++){var b=g[s][0],y=g[s][1],r=g[s].slice(2),k=y?at:lt;t.beginStroke(k).setStrokeStyle(vt);y?t.setStrokeDash([4/n.boxLayer[1],2/n.boxLayer[1]],0):t.setStrokeDash([3e3,0],0);switch(b){case 0:u={x:(r[0]-e)*i,y:(r[1]-o)*i};f={x:(r[2]-e)*i,y:(r[3]-o)*i};u=h(u);f=h(f);t.moveTo(u.x,u.y);t.lineTo(f.x,f.y);break;case 1:u={x:(r[0]-e)*i,y:(r[1]-o)*i};u=h(u);p=-r[4];w=-r[3];t.arc(u.x,u.y,r[2]*i,Math.PI*st(p/180),Math.PI*st(w/180),rt);break;case 2:for(u={x:(r[0]-e)*i,y:(r[1]-o)*i},u=h(u),t.moveTo(u.x,u.y),c=1;c<r.length/2;c++)f={x:(r[c*2]-e)*i,y:(r[c*2+1]-o)*i},f=h(f),t.lineTo(f.x,f.y);break;case 3:u={x:(r[0]-e)*i,y:(r[1]-o)*i};u=h(u);f={x:(r[2]-e)*i,y:(r[3]-o)*i};f=h(f);l={x:(r[4]-e)*i,y:(r[5]-o)*i};l=h(l);a={x:(r[6]-e)*i,y:(r[7]-o)*i};a=h(a);t.moveTo(u.x,u.y);t.bezierCurveTo(f.x,f.y,l.x,l.y,a.x,a.y);break;default:continue}}}var b=r.getChildByName(f(n.boxLayer)).children[0],it,rt,ot,yt,w,tt,c;t||(tu(),it=b.children[0],b.regX=s[0]*u/2,b.regY=s[1]*u/2,it.regX=-b.regX-(l[0]-s[0]*u)/2,it.regY=-b.regY-(l[1]-s[1]*u)/2);t=t||b.children[0].children[0].graphics;lt=lt||"#666";at=at||"#666";var ft=n.boxLayer[1],vt=1/n.boxLayer[1],g=n.boxResx.lines,et=n.boxResx.boxJson,e=et.OffsetX,o=et.OffsetY,i=y*u;t.clear();rt=!1;n.isFaceB&&(rt=!0);ot=s[0]*u/2;yt=s[1]*u/2;pt();var b=r.getChildByName(f(n.boxLayer)).children[0].children[0],ht=b.children[1],ct=b.children[2];if(ht.children=[],ct.children=[],a.data.length){w=(a.fontSize/n.boxLayer[1]).toFixed(3);yu()&&(w=w>1?w:.5);var wt=w+"px Arial",nt=a.colors,bt=a.data,k=Math.sin,d=Math.cos,p=.7*4*i/n.boxLayer[1],v=function(n,i,r,u){var e,o,s;r=r||0;u=u||0;var a=r+90,v=r+-90,y=r+90+60,w=r+-90-60,b=r+180;a*=Math.PI/180;v*=Math.PI/180;y*=Math.PI/180;w*=Math.PI/180;b*=Math.PI/180;e={x:n+p*d(a),y:i-p*k(a)};o={x:n+p*d(v),y:i-p*k(v)};e=h(e);o=h(o);t.moveTo(e.x,e.y);t.lineTo(o.x,o.y);var c={x:n+p*d(y),y:i-p*k(y)},f={x:n,y:i},l={x:n+p*d(w),y:i-p*k(w)};c=h(c);f=h(f);l=h(l);t.moveTo(c.x,c.y);t.lineTo(f.x,f.y);t.lineTo(l.x,l.y);u&&(s={x:n+u*p*d(b),y:i-u*p*k(b)},s=h(s),t.moveTo(s.x,s.y),t.lineTo(f.x,f.y))};ut=ut||document.createElement("CANVAS");tt=ut.getContext("2d");c=n.boxLayer[1]>1?n.boxLayer[1]:1;_.forEach(bt,function(r,u){var f,p,y,k,it,d,ut,s,l,g,et,ot;if(t.beginStroke(nt[r[6]]).setStrokeStyle(.6/n.boxLayer[1]),f=new createjs.Text(r[4],wt,nt[r[6]]),f.textAlign="center",f.textBaseline="middle",f.$Sign={idx:u,data:r},ht.addChild(f),p={"1":5,"2":-5,"3":0}[r[5]]/i/c,_.startsWith(r[2],"x")&&(f.x=(r[0]+r[3]/2-e)*i,f.y=(r[1]-o)*i,f.y+=r[2]!="xb"?-(.5*w+4)/c:(.5*w+4)/c,r[3]*c>=10?(s={x:(r[0]-e+p)*i,y:(r[1]-o)*i},s=h(s),l={x:(r[0]+r[3]-e-p)*i,y:(r[1]-o)*i},l=h(l),t.moveTo(s.x,s.y),t.lineTo(l.x,l.y),v((r[0]-e+p)*i,(r[1]-o)*i,180),v((r[0]+r[3]-e-p)*i,(r[1]-o)*i)):(v((r[0]-e+p)*i,(r[1]-o)*i,0,4),v((r[0]+r[3]-e-p)*i,(r[1]-o)*i,180,4))),_.startsWith(r[2],"y")&&(f.x=(r[0]-e)*i,f.y=(r[1]+r[3]/2-o)*i,ut=(tt.measureText(f.text).width+24)*.5/c,f.x+=r[2]!="yl"?ut:-ut,r[3]*c>=10?(s={x:(r[0]-e)*i,y:(r[1]-o+p)*i},s=h(s),l={x:(r[0]-e)*i,y:(r[1]+r[3]-o-p)*i},l=h(l),t.moveTo(s.x,s.y),t.lineTo(l.x,l.y),v((r[0]-e)*i,(r[1]-o+p)*i,90),v((r[0]-e)*i,(r[1]+r[3]-o-p)*i,-90)):(v((r[0]-e)*i,(r[1]-o+p)*i,-90,4),v((r[0]-e)*i,(r[1]+r[3]-o-p)*i,90,4))),_.startsWith(r[2],"r")){var yt=_.toNumber(r[2].substr(1)),st=r[3]*1.414/2,b=r[3]*1.414/2+20/c,lt=(tt.measureText(f.text).width+10)/1/c;f.x=(r[0]-e+(r[2]=="r1"||r[2]=="r4"?b+lt*.5:-b-lt*.5))*i;f.y=(r[1]-o+(r[2]=="r1"||r[2]=="r2"?-b:b))*i;f.y+=-.5*w/c;var s={x:(r[0]-e)*i,y:(r[1]-o)*i},l={x:(r[0]-e+(r[2]=="r1"||r[2]=="r4"?b:-b))*i,y:(r[1]-o+(r[2]=="r1"||r[2]=="r2"?-b:b))*i},g={x:(r[0]-e+(r[2]=="r1"||r[2]=="r4"?b+lt:-b-lt))*i,y:(r[1]-o+(r[2]=="r1"||r[2]=="r2"?-b:b))*i};s=h(s);l=h(l);g=h(g);t.moveTo(s.x,s.y);t.lineTo(l.x,l.y);t.lineTo(g.x,g.y);v((r[0]-e+(r[2]=="r1"||r[2]=="r4"?st:-st))*i,(r[1]-o+(r[2]=="r1"||r[2]=="r2"?-st:st))*i,45+90*(yt-1),0)}_.startsWith(r[2],"a")&&(y=_.toNumber(r[2].substr(1)),k=y+r[3],_.startsWith(r[2],"ac")&&(k=_.toNumber(r[2].substr(2)),y=k-r[3]),y*=Math.PI/180,k*=Math.PI/180,it=20/c,d=20/c,f.x=(r[0]-e+d*Math.cos(y))*i,f.y=(r[1]-o-d*Math.sin(y))*i,ut=tt.measureText(f.text).width/c,f.x+=ut*Math.cos(y),f.y+=-w/c*Math.sin(y),s={x:(r[0]-e+it*Math.cos(y))*i,y:(r[1]-o-it*Math.sin(y))*i},l={x:(r[0]-e+d*Math.cos(y))*i,y:(r[1]-o-d*Math.sin(y))*i},s=h(s),l=h(l),t.moveTo(s.x,s.y),t.lineTo(l.x,l.y),g={x:(r[0]-e+it*Math.cos(k))*i,y:(r[1]-o-it*Math.sin(k))*i},et={x:(r[0]-e+d*Math.cos(k))*i,y:(r[1]-o-d*Math.sin(k))*i},g=h(g),et=h(et),t.moveTo(g.x,g.y),t.lineTo(et.x,et.y),v((r[0]-e+.5*(it+d)*Math.cos(y))*i,(r[1]-o-.5*(it+d)*Math.sin(y))*i,y*180/Math.PI+90,2),v((r[0]-e+.5*(it+d)*Math.cos(k))*i,(r[1]-o-.5*(it+d)*Math.sin(k))*i,k*180/Math.PI-90,2));n.isFaceB&&(ot={x:f.x,y:f.y},ot=h(ot),f.x=ot.x,f.y=ot.y);a.selected==f.$Sign.idx&&(f.color=nt[2]);var at=f.getMeasuredWidth()+15/ft,vt=f.getMeasuredHeight()+15/ft,rt=new createjs.Shape;f.$Rect=rt;ct.addChild(rt);rt.alpha=.01;rt.graphics.beginFill(nt[r[6]]).drawRect(f.x-at/2,f.y-vt/2,at,vt);rt.setBounds(f.x-at/2,f.y-vt/2,at,vt);rt.$Sign=f.$Sign})}}function rr(n){var i,u,t;wt&&(i=a.colors,a.selected>-1&&(u=_.get(a,"data["+a.selected+"]"),u&&(t=wt.children[a.selected],t.color=i[u[6]],t.$Rect.alpha=.01)),a.selected=n,t=wt.children[n],t&&(window.$Txt=t,t.color=i[2],t.$Rect.alpha=.2),r.update(),tt.sign_mousedown(n))}function ur(n){var i=_.bind(n?e.removeEventListener:e.addEventListener,e),t;i("contextmenu",pu,!1);i("mousedown",wu,!1);i("mousewheel",or,{passive:!0});i("DOMMouseScroll",or,{passive:!0});i("touchstart",bu,{passive:!0});i("touchend",du,{passive:!0});i("touchmove",ku,{passive:!0});n&&r&&(t=r.$Rect,t&&(t.off("mouseover",t.mouseover_rect),t.off("mouseout",t.mouseout_rect),t.off("mousedown",t.mousedown_rect)),$.each(r.children,function(n,t){!_.isUndefined(t.children)&&t.children.length>0&&(t.children[0].off("mouseover",t.children[0].handleOver),t.children[0].off("mouseout",t.children[0].handleOut),!_.isUndefined(t.children[0].children)&&t.children[0].children.length>1&&t.children[0].children[1].off("mousedown",t.children[0].children[1].handleDown))}));createjs.Touch.enable(r)}function kt(){return i.length?bt=_.cloneDeep(i):null,v=_.cloneDeep(i[0]),o=_.cloneDeep(i[0])}function pu(n){n.preventDefault()}function wu(n){if(g){b=="table"&&(rt(1),yt(1));c=1;kt();var t=n.clientX-e.clientLeft,i=n.clientY-e.clientTop;v[4]=o[4]=t;v[5]=o[5]=i;e.addEventListener("mousemove",fr,!1);e.addEventListener("mouseup",er,!1)}}function fr(n){var t=n.clientX-e.clientLeft,r=n.clientY-e.clientTop;if(g&&i.length)return c==1?(o[4]=t,o[5]=r,ti(1)):void 0}function er(){g&&c!=0&&(c==1&&b=="table"&&(c=0,rt(0),d(),it=1),c=0,e.removeEventListener("mousemove",fr),e.removeEventListener("mouseup",er),b=="all"&&k())}function or(t){if(g){c=3;var r=0;t.wheelDelta?r=t.wheelDelta/1e4:t.detail&&(r=-t.detail/1e3);r*=ei;ft&&i.length!=_.concat([n.boxLayer],n.layers).length||r&&(b=="all"?(ai({"1":r,"2":r}),k()):(rt(1),yt(1),ai({"1":r,"2":r}),c=0,rt(0),d(),it=1),c=0)}}function bu(n){if(g){b=="table"&&(rt(1),yt(1));kt();switch(n.touches.length){case 1:c=1;v[4]=o[4]=n.touches[0].pageX;v[5]=o[5]=n.touches[0].pageY;break;case 2:c=2;var t=n.touches[0].pageX-n.touches[1].pageX,i=n.touches[0].pageY-n.touches[1].pageY;v[1]=o[1]=v[2]=o[2]=Math.sqrt(t*t+i*i)/200}}}function ku(t){if(g)switch(t.touches.length){case 1:if(c!=1)return;o[4]=t.touches[0].pageX;o[5]=t.touches[0].pageY;ti();break;case 2:if(c!=2)return;if(!ft||i.length==_.concat([n.boxLayer],n.layers).length){var r=t.touches[0].pageX-t.touches[1].pageX,u=t.touches[0].pageY-t.touches[1].pageY;o[1]=o[2]=Math.sqrt(r*r+u*u)/200;bt=_.cloneDeep(i);ti();v[1]=o[1];v[2]=o[2]}}}function du(n){if(g){c>0&&b=="table"&&(c=0,rt(0),d(),it=1);c=0;switch(n.touches.length){case 1:if(c!=1)return;v[4]=o[4]=v[5]=o[5]=0;break;case 2:if(c!=2)return;v[1]=o[1]=v[2]=o[2]=0}b=="all"&&k()}}function gu(n,i){var f=_.get(window,"ART"),u=_.get(window,"D3"),r;if(f&&u){i=i||"#fff";n=n||"ka";r=ut=ut||document.createElement("CANVAS");switch(n){case"ka":t.refreshOutputCanvas(0,function(n){r.width=n.width;r.height=n.height;var f=r.getContext("2d");t.drawColorBg({ctx:f,bgColor:i,alpha:1});u.changeImageB(r,1,function(){f.drawImage(n,0,0,n.width,n.height);u.changeImageA(r,1)})});_.extend(u.curModel.mesh.objCal.material.color,{r:.6,g:.6,b:.6});_.extend(u.curModel.mesh.objLine.material.color,{r:.6,g:.6,b:.6});break;default:t.refreshOutputCanvas(0,function(i){r.width=i.width;r.height=i.height;var f=r.getContext("2d");t.drawImageBg({ctx:f,paper:n,face:"A"}).then(function(){f.drawImage(i,0,0,i.width,i.height);u.changeImageA(r,1,function(){t.drawImageBg({ctx:f,paper:n,face:"B"}).then(function(){u.changeImageB(r,1)})})});_.extend(u.curModel.mesh.objCal.material.color,{r:169/255,g:147/255,b:122/255});_.extend(u.curModel.mesh.objLine.material.color,{r:169/255,g:147/255,b:122/255})})}}}function nf(n){var t=n.ctx,i=t.canvas,r;(t.clearRect(0,0,i.width,i.height),n.alpha<=0||!n.bgColor)||(r=t.globalAlpha,t.globalAlpha=n.alpha,t.fillStyle=n.bgColor,t.fillRect(0,0,i.width,i.height),t.globalAlpha=r)}function tf(n,t,i,r,u,f){var e=n.canvas,h=e.width/u|0,c=e.height/f|0,o=Math.ceil(u),s=Math.ceil(f),a,v,l;for(o+=o%2==0?1:0,s+=s%2==0?1:0,n.clearRect(0,0,e.width,e.height),a=i=="right"?-(o-u)*h:i=="center"?-(o*h-e.width)*.5:0,v=r=="bottom"?-(s-f)*c:r=="middle"?-(s*c-e.height)*.5:0,l=0;l<o;l++)for(j=0;j<s;j++)n.drawImage(t,l*h+a,j*c+v,h,c)}function rf(n){return new Promise(function(i){var u=n.ctx.canvas,f=_.get(t,"data.boxResx.boxJson.Width")||u.width,e=_.get(t,"data.boxResx.boxJson.Height")||u.height,o=Math.max(f,e),r;(sx=10*f/o,sy=10*e/o,sx<=0||sy<=0)||(r=document.createElement("IMG"),r.src="/Images/Cad/Paper/"+n.paper+"_"+n.face+".jpg",r.onload=function(){tf(n.ctx,r,n.align,n.valign,sx,sy);i(u)})})}var t=ART,p,h,ni,ut,pt,wt,tt,g,c,bt,v,o;String.prototype.exLang=_.get(window,"Cm.exLang")||function(){};var r=null,e=null,w=300,uf=Math.PI/180,y=w/25.4,nt=.88,l,u,n,i=[],s,wi=[],ui=null,dt=0,fi=0,ft=0,et={fileBinaryString:"",fileName:"",thum:null,texture3D:null},bi=[.05,100],gt=3,ei=1,oi="contain",ht=1,si="red",b="all",it=0,a={choose:1,fontSize:12,colors:["#de7a00","#1f801f","#c800c8","#c8c800"],data:[],selected:-1,alived:-1},lt="#666",at="#666",hr=["jpg","jpeg","pdf","png","tif","tiff","gif"],hi={noBoxStruct:1};p=-1;h=[];ni=0;ut=null;tt={sign_mousedown:Cm.EMPTY_FUN,image_mousedown:Cm.EMPTY_FUN,observeData:Cm.EMPTY_FUN};g=1;c=0;Cm.createGetterSetter(t,"init",function(){return gr});Cm.createGetterSetter(t,"changeMode",function(){return cr});Cm.createGetterSetter(t,"changeSize",function(){return kr});Cm.createGetterSetter(t,"draw",function(){return nu});Cm.createGetterSetter(t,"addRecord",function(){return k});Cm.createGetterSetter(t,"goBack",function(){return ar});Cm.createGetterSetter(t,"reDo",function(){return lr});Cm.createGetterSetter(t,"goHistory",function(){return ot});Cm.createGetterSetter(t,"doInput",function(){return ou});Cm.createGetterSetter(t,"stage",function(){return r});Cm.createGetterSetter(t,"dpi",function(){return w},function(n){w=n});Cm.createGetterSetter(t,"zoom",function(){return nt},function(n){nt=n});Cm.createGetterSetter(t,"scale",function(){return u});Cm.createGetterSetter(t,"selectAll",function(){return yt});Cm.createGetterSetter(t,"selected",function(){return i},function(n){i=n});Cm.createGetterSetter(t,"select",function(){return ct});Cm.createGetterSetter(t,"data",function(){return n},function(t){n=t});Cm.createGetterSetter(t,"outData",function(){return et});Cm.createGetterSetter(t,"reset",function(){return ii});Cm.createGetterSetter(t,"outputThumbnail",function(){return br});Cm.createGetterSetter(t,"setDelta",function(){return ai});Cm.createGetterSetter(t,"refreshOutputCanvas",function(){return wr});Cm.createGetterSetter(t,"genUpdate",function(){return yr});Cm.createGetterSetter(t,"fromUploadData",function(){return pr});Cm.createGetterSetter(t,"enabled",function(){return g},function(n){g=n});Cm.createGetterSetter(t,"hasNewUpdate",function(){return ni},function(n){ni=n});Cm.createGetterSetter(t,"idxLayers",function(){return dt},function(n){dt=n});Cm.createGetterSetter(t,"maxSize",function(){return ui?ui:ui=Cm.getMaxRenderSize()});Cm.createGetterSetter(t,"outputOption",function(){return hi},function(n){hi=n});Cm.createGetterSetter(t,"Bleeding",function(){return gt},function(n){gt=n});Cm.createGetterSetter(t,"scaleRate",function(){return ei},function(n){ei=n});Cm.createGetterSetter(t,"records",function(){return h});Cm.createGetterSetter(t,"includeSelected",function(){return iu});Cm.createGetterSetter(t,"delLayer",function(){return ru});Cm.createGetterSetter(t,"sortLayer",function(){return uu});Cm.createGetterSetter(t,"reorderLayer",function(){return fu});Cm.createGetterSetter(t,"render",function(){return d});Cm.createGetterSetter(t,"fitBoxWidth",function(){return hu});Cm.createGetterSetter(t,"fitBoxHeight",function(){return cu});Cm.createGetterSetter(t,"addFirstLayer",function(){return addFirstLayer});Cm.createGetterSetter(t,"sign",function(){return a},function(n){a=n});Cm.createGetterSetter(t,"refreshStructure",function(){return function(){pi();r.update()}});Cm.createGetterSetter(t,"refreshStage",function(){return function(){st()}});Cm.createGetterSetter(t,"colorSolid",function(){return lt},function(n){lt=n});Cm.createGetterSetter(t,"colorDash",function(){return at},function(n){at=n});Cm.createGetterSetter(t,"changeSignSelected",function(){return rr});Cm.createGetterSetter(t,"on",function(){return function(n,t){tt[n]=t}});Cm.createGetterSetter(t,"canvas",function(){return e});Cm.createGetterSetter(t,"drawStage",function(){return function(){dr()}});Cm.createGetterSetter(t,"boxSize",function(){return s});Cm.createGetterSetter(t,"selectMode",function(){return oi},function(n){oi=n});Cm.createGetterSetter(t,"drawMask",function(){return ht},function(n){ht=n});Cm.createGetterSetter(t,"maskClor",function(){return si},function(n){si=n});Cm.createGetterSetter(t,"drawColorBg",function(){return nf});Cm.createGetterSetter(t,"drawImageBg",function(){return rf});Cm.createGetterSetter(t,"changeD3Paper",function(){return gu});Cm.createGetterSetter(t,"mouseMode",function(){return b},function(n){b=n});Cm.createGetterSetter(t,"addCahceRecord",function(){return vr})})();