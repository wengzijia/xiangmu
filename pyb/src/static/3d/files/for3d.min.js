var Zw={Vesion:"1.0",_ImageA:"/Diy/ref/gl/Img/White.png",get ImageA(){return this._ImageA},set ImageA(n){this._ImageA=n},_ImageB:"/Diy/ref/gl/Img/SknowWhite.png",get ImageB(){return this._ImageB},set ImageB(n){this._ImageB=n}};Zw.callAfterInit=$.Callbacks("unique");Zw.callAfterLoad=$.Callbacks("unique");Zw.factoryOfTextureAB=function(){var f=0,i=document.createElement("canvas"),r=document.createElement("canvas"),n=i.getContext("2d"),t=r.getContext("2d"),u;return i.width=i.height=r.width=r.height=2,n.fillStyle=t.fillStyle="white",n.fillRect(0,0,n.canvas.width,n.canvas.height),t.fillRect(0,0,t.canvas.width,t.canvas.height),u=function(n,t){var i=t/Math.max(Zw.BoxW,Zw.BoxH);n.canvas.width=Math.floor(i*Zw.BoxW);n.canvas.height=Math.floor(i*Zw.BoxH);n.fillStyle="white";n.fillRect(0,0,n.canvas.width,n.canvas.height)},{get isRendering(){return f},set isRendering(n){f=n},maxSize:2048,setCanvasSize:function(){u(this.contextA,this.maxSize);this.isDoubleTexture&&u(this.contextB,this.maxSize)},isDoubleTexture:0,canvasA:i,canvasB:r,contextA:n,contextB:t}}();Zw.Zoom=1;Zw.MaxSize=200;Zw.OffsetX=0;Zw.OffsetY=0;Zw.Left=0;Zw.Right=0;Zw.Top=0;Zw.Bottom=0;Zw.fixLeft=0;Zw.fixRight=0;Zw.fixTop=0;Zw.fixBottom=0;Zw.BoxW=0;Zw.BoxH=0;Zw.MaxAngleStep=0;Zw.Cal=1;Zw.CurrMesh=null;Zw.Meshes=[];Zw.FoldMovie=[];Zw.AutoFoldOnClick=!1;Zw.EventOnclickMesh=function(){};Zw.setPlaneAlpha=function(n,t){var i,r;if(Zw.isNull(n.objA)||(i=t?.5:1,n.objA.material.opacity=i,n.objB.material.opacity=i,n.objCal.material.opacity=i,n.objFold&&(n.objFold.material.opacity=i)),!Zw.isNull(n.children))for(r=0;r<n.children.length;r++)Zw.setPlaneAlpha(n.children[r],t)};Zw.loadOne=function(n){var t,r,i;return Zw.setBoxBorder(n.Border[0],n.Border[1],n.Border[2],n.Border[3],n.Border[4]),t=Zw.generatePlanes(n.Rel),$.each(n.Planes,function(n,i){t[n].setVertices(i.Vertices);t[n].setFaces(i.Faces);t[n].setCutlinesToDraw(i.CutlinesToDraw);t[n].setFoldlinesToDraw(i.FoldlinesToDraw);t[n].removeCutlinesInFoldlines();!i.FoldLine||t[n].setFoldLine(i.FoldLine[0],i.FoldLine[1],i.FoldLine[2],i.FoldLine[3],i.FoldLine[4])}),r=new Zw.Show3D(t),i=r.draw(),Zw.addMesh(i),i};Zw.findMeshIndexByDiyID=function(n){var t=-1;return $.each(Zw.Meshes,function(i,r){if(r.DiyID==n)return t=i,!1}),t};THREE.Vector2.prototype.fix=function(){return this};THREE.Vector3.prototype.findTexture=function(n){return new THREE.Vector2((this.x-n.fixLeft)/n.BoxW,1-(-this.y-n.fixTop)/n.BoxH)};THREE.Vector2.prototype.toVector3=function(){return new THREE.Vector3(this.x,this.y,0)};Zw.addMesh=function(n){Zw.Meshes.push(n);Zw.isNull(Zw.CurrMesh)&&(Zw.CurrMesh=n);n.foldMovieIdx=Zw.Meshes.length-1};Zw.removeMesh=function(n){Zw.Meshes.pop(n)};Zw.sortPosition=function(n){var r,i,t;if(n=n||20,Zw.Meshes.length!=0){for(r=Math.floor((Zw.Meshes.length-1)/2),Zw.Meshes[r].moveToOrg(),i=Zw.Meshes[r].setting.BoxW/2,t=r+1;t<Zw.Meshes.length;t++)i+=n+Zw.Meshes[t].setting.BoxW/2,Zw.Meshes[t].moveToOrg(),Zw.Meshes[t].position.x+=i,i+=Zw.Meshes[t].setting.BoxW/2;for(i=-Zw.Meshes[r].setting.BoxW/2,t=r-1;t>=0;t--)i-=n+Zw.Meshes[t].setting.BoxW/2,Zw.Meshes[t].moveToOrg(),Zw.Meshes[t].position.x+=i,i-=Zw.Meshes[t].setting.BoxW/2}};Zw.DefaultError=function(n){console.log(n)};Zw.setBoxBorder=function(n,t,i,r,u){Zw.MaxAngleStep=0;Zw.Left=n;Zw.Right=i;Zw.Top=t;Zw.Bottom=r;Zw.Cal=u||1;Zw.OffsetX=-(Zw.Right+Zw.Left)/2;Zw.OffsetY=-(Zw.Bottom+Zw.Top)/2;Zw.BoxW=Zw.Right-Zw.Left;Zw.BoxH=Zw.Bottom-Zw.Top;Zw.Zoom=Zw.MaxSize/Math.max(Zw.BoxW,Zw.BoxH);Zw.factoryOfTextureAB.setCanvasSize();Zw.fixX=function(n){return n};Zw.fixY=function(n){return n};Zw.fixLeft=Zw.fixX(n);Zw.fixRight=Zw.fixX(i);Zw.fixTop=Zw.fixY(t);Zw.fixBottom=Zw.fixY(r)};Zw.isNull=function(n){return typeof n=="undefined"||n==null};Zw.generatePlanes=function(n){var r=[],t=$(this),i;return $.each(n,function(n,i){i.indexOf(":")!=-1&&(i=i.substr(0,i.indexOf(":")));var u=new Zw.Plane(i);r.push(u);t.data(i,u)}),i=null,$.each(n,function(n,r){var u,f,e;if(!i)return i=r,!0;r.indexOf(":")==-1&&(r+=":"+i);u=r.substr(0,r.indexOf(":"));baseP=r.substr(r.indexOf(":")+1);Zw.isNull(t.data(u))||Zw.isNull(t.data(baseP))||(f=t.data(u),e=t.data(baseP),f.setBasePlane(e))}),r};Zw.findPlane=function(n,t){var i={};return $.each(n,function(n,r){if(r.name==t){i=r;return}}),i};Zw.getCirclePts=function(){};Zw.eventOnDocumentMouseDown=function(n){var t,u,i,r;if(Zw.ClientClick){Zw.ClientClick=!1;return}n.preventDefault();t=new THREE.Vector3(n.clientX/window.innerWidth*2-1,-(n.clientY/window.innerHeight)*2+1,.5);t.unproject(camera);u=new THREE.Raycaster(camera.position,t.sub(camera.position).normalize());i=u.intersectObjects(Zw.Meshes,!0);i.length>0&&(r=i[0].object,Zw.isNull(r.plane)||(Zw.CurrMesh=r.plane.topMesh,Zw.EventOnclickMesh(Zw.EventOnclickMesh(Zw.CurrMesh.foldMovieIdx)),Zw.AutoFoldOnClick&&Zw.FoldMovie[Zw.CurrMesh.foldMovieIdx].doChange()))};Zw.ClientClick=!1;Zw.Setting=function(){this.Zoom=1;this.MaxSize=200;this.OffsetX=0;this.OffsetY=0;this.Left=0;this.Right=0;this.Top=0;this.Bottom=0;this.fixLeft=0;this.fixRight=0;this.fixTop=0;this.fixBottom=0;this.BoxW=0;this.BoxH=0;this.MaxAngleStep=0};Zw.Setting.prototype={constructor:Zw.Setting,setBoxBorder:function(n,t,i,r,u){this.MaxAngleStep=0;this.Left=n;this.Right=i;this.Top=t;this.Bottom=r;this.Cal=u||1.5;this.OffsetX=-(this.Right+this.Left)/2;this.OffsetY=-(this.Bottom+this.Top)/2;this.BoxW=this.Right-this.Left;this.BoxH=this.Bottom-this.Top;this.Zoom=this.MaxSize/Math.max(this.BoxW,this.BoxH);this.fixX=function(n){return n};this.fixY=function(n){return n};this.fixLeft=this.fixX(n);this.fixRight=this.fixX(i);this.fixTop=this.fixY(t);this.fixBottom=this.fixY(r)}};Zw.Plane=function(){arguments.length>=1&&(this.name=arguments[0]);arguments.length>=2&&(this.foldLine=arguments[1]);this.group=new THREE.Group;this.group.name=this.name};Zw.Plane.prototype={constructor:Zw.Plane,setVertices:function(n){if(n.length%2!=0){this.error="构成点集所需数组必须是2的倍数";this.onErrorCallback();return}this.vertices=[];for(var t=0;t<n.length/2;t++)this.vertices.push(new THREE.Vector2(n[t*2],-n[t*2+1]).toVector3())},setFaces:function(n){if(n.length%3!=0){this.error="构成三角形集合所需数组必须是3的倍数";this.onErrorCallback();return}this.faces=[];for(var t=0;t<n.length/3;t++)this.faces.push(new THREE.Face3(n[t*3],n[t*3+1],n[t*3+2]))},setFaceVertexUvs:function(n){if(Zw.isNull(this.vertices)||Zw.isNull(this.faces)){this.error="面的三角形集合为空！";this.onErrorCallback();return}this.faceVertexUvs=[];for(var t=0;t<this.faces.length;t++)this.faceVertexUvs.push([this.vertices[this.faces[t].a].findTexture(n),this.vertices[this.faces[t].b].findTexture(n),this.vertices[this.faces[t].c].findTexture(n)])},logTrianglesToString:function(){var n="";return $(this.triangles).each(function(t,i){t!=0&&(n+="\r\n");n+=i.toString()}),n},onErrorCallback:function(){Zw.DefaultError(this.error)},onError:function(n){return this.onErrorCallback=n,this},setGroupPostion:function(){this.hasBase()&&this.basePlane.hasBase()?!this.foldLine||!this.basePlane.foldLine||this.group.position.set(this.foldLine.from.x-this.basePlane.foldLine.from.x,this.foldLine.from.y-this.basePlane.foldLine.from.y,0):!this.foldLine||this.group.position.set(this.foldLine.from.x,this.foldLine.from.y,0)},setBasePlane:function(n){return this.basePlane=n,n.group.add(this.group),this},hasBase:function(){return!Zw.isNull(this.basePlane)},setFoldLine:function(){if(arguments.length==5)return arguments[4].length==0?void 0:(this.foldLine=new Zw.FoldLine(Zw.fixX(arguments[0]),-Zw.fixY(arguments[1]),Zw.fixX(arguments[2]),-Zw.fixY(arguments[3]),arguments[4]),Zw.MaxAngleStep<this.foldLine.phaseAngle.length&&(Zw.MaxAngleStep=this.foldLine.phaseAngle.length),this);this.error="折线的初始化数据不正确！";this.onErrorCallback();return},eachFoldLine:function(n){Zw.isNull(this.foldLine)&&Zw.isNull(this.basePlane)||(Zw.isNull(this.foldLine)||n(this.foldLine),Zw.isNull(this.basePlane)||this.basePlane.eachFoldLine(n))},getAllFoldLine:function(){var n=[];return this.eachFoldLine(function(t){n.push(t)}),n},getRelations:function(){var t=function(n){Zw.isNull(this.foldLine)&&Zw.isNull(this.basePlane)||(Zw.isNull(this.foldLine)||n(this.name),Zw.isNull(this.basePlane)||this.basePlane.eachFoldLine(n))},n=[];return t(function(t){n.push(t)}),n},setCutlinesToDraw:function(n){if(n.length%2!=0){this.error="面"+this.name+"的cutlinesToDraw的长度必须是2的倍数！"+n;this.onErrorCallback();this.cutlinesToDraw=[];return}this.cutlinesToDraw=n},setFoldlinesToDraw:function(n){if(n){if(n.length%2!=0){this.error="面"+this.name+"的foldlinesToDraw的长度必须是2的倍数！";this.onErrorCallback();return}this.foldlinesToDraw=n}},removeCutlinesInFoldlines:function(){var n=this.cutlinesToDraw,i=this.foldlinesToDraw,u,f,t,r;if(i&&i.length&&n&&n.length){for(u=[],f=!1,t=0;t<n.length;t+=2){for(f=!1,r=0;r<i.length;r+=2)if(n[t]==i[r]&&n[t+1]==i[r+1]||n[t]==i[r+1]&&n[t+1]==i[r]){f=!0;break}f||(u.push(n[t]),u.push(n[t+1]))}this.cutlinesToDraw=u}}};Zw.FoldLine=function(){return arguments.length==3?(this.from=arguments[0],this.to=arguments[1],this.phaseAngle=arguments[2]):arguments.length==5&&(this.from=new THREE.Vector2(arguments[0],arguments[1]),this.to=new THREE.Vector2(arguments[2],arguments[3]),this.phaseAngle=arguments[4]),this};Zw.FoldLine.prototype={constructor:Zw.FoldLine,getCurrentAngle:function(n,t){if(t<this.phaseAngle.length&&(t=this.phaseAngle.length),t-=1,n<=0||this.phaseAngle.length==1)return this.phaseAngle[0];if(n>=1)return this.phaseAngle[this.phaseAngle.length-1];var r=t*n,i=Math.floor(r);return i>=this.phaseAngle.length-1?this.phaseAngle[this.phaseAngle.length-1]:this.phaseAngle[i]+(r-i)*(this.phaseAngle[i+1]-this.phaseAngle[i])},toString:function(){return"("+this.from.x+","+this.from.y+") --> ("+this.to.x+","+this.to.y+")"}};Zw.Movie=function(n){this.runStatus=!1;this.interval=n};Zw.Movie.prototype={constructor:Zw.Movie,onErrorCallback:function(){Zw.DefaultError(this.error)},onError:function(n){return this.onErrorCallback=n,this},onRefrashCallback:function(){},onRefrash:function(n){return this.onRefrashCallback=n,this},setCallBack:function(n){this.__callback=n},sh:null,on:function(){this.runStatus=!0;var n=this;n.sh!=null&&clearInterval(n.sh);this.sh=setInterval(function(){try{n.onRefrashCallback();!n.__callback||n.__callback()}catch(t){n.error=t.message;n.onErrorCallback();n.runStatus=!1}n.runStatus||clearInterval(n.sh)},n.interval)},off:function(){this.runStatus=!1},doChange:function(){this.runStatus?this.runStatus=!1:this.on()}};Zw.Show3D=function(n){this.planes=n;this.percent=0;this.topMesh=null;this.percentDiff=.03;this.isFold=!0;this.setting=new Zw.Setting;this.setting.setBoxBorder(Zw.Left,Zw.Top,Zw.Right,Zw.Bottom,Zw.Cal)};Zw.Show3D.prototype={constructor:Zw.Show3D,drawOnePlane:function(n,t,i,r,u,f){var c=new THREE.Geometry,v,b,k,y,h,a,o,s,g,d,e,nt,tt;c.vertices=n.vertices;c.faces=n.faces;c.faceVertexUvs[0]=n.faceVertexUvs;c.computeFaceNormals();var l=new THREE.Geometry,p=new THREE.Mesh(c,t),w=new THREE.Mesh(c,i);for(!n.foldLine||this.fixMesh(p,-n.foldLine.from.x,-n.foldLine.from.y),v=new THREE.Geometry,e=0;e<n.cutlinesToDraw.length/2;e++)o=c.vertices[n.cutlinesToDraw[e*2]],s=c.vertices[n.cutlinesToDraw[e*2+1]],l.vertices.push(new THREE.Vector3(o.x,o.y,-this.setting.Cal/2)),l.vertices.push(new THREE.Vector3(o.x,o.y,this.setting.Cal/2)),l.vertices.push(new THREE.Vector3(s.x,s.y,this.setting.Cal/2)),l.vertices.push(new THREE.Vector3(s.x,s.y,-this.setting.Cal/2)),l.faces.push(new THREE.Face3(e*4,e*4+1,e*4+2)),l.faces.push(new THREE.Face3(e*4,e*4+2,e*4+3)),v.vertices.push(new THREE.Vector3(s.x,s.y,-this.setting.Cal/2)),v.vertices.push(new THREE.Vector3(o.x,o.y,-this.setting.Cal/2)),v.vertices.push(new THREE.Vector3(o.x,o.y,this.setting.Cal/2)),v.vertices.push(new THREE.Vector3(s.x,s.y,this.setting.Cal/2));if(l.computeFaceNormals(),b=new THREE.Mesh(l,r),k=new THREE.LineSegments(v,f),p.position.z=this.setting.Cal/2,w.position.z=-this.setting.Cal/2,n.group.add(p),n.group.add(w),n.group.add(b),n.group.add(k),n.group.objA=p,n.group.objB=w,n.group.objCal=b,n.group.objLine=k,n.group.isPerspectiveMode=!1,p.plane=this,w.plane=this,b.plane=this,k.plane=this,n.hasBase()||(this.topMesh?console.error("注意：盒型结构不合理，同时存在两个根面！"):(this.topMesh=n.group,this.topMesh.position.set(Zw.OffsetX,-Zw.OffsetY,0))),y=n.getAllFoldLine(),n.foldlinesToDraw){for(h=new THREE.Geometry,a=new THREE.Geometry,e=0;e<n.foldlinesToDraw.length/2;e++)o=c.vertices[n.foldlinesToDraw[e*2]],s=c.vertices[n.foldlinesToDraw[e*2+1]],h.vertices.push(new THREE.Vector3(o.x,o.y,0)),h.vertices.push(new THREE.Vector3(o.x,o.y,this.setting.Cal/2)),h.vertices.push(new THREE.Vector3(s.x,s.y,this.setting.Cal/2)),h.vertices.push(new THREE.Vector3(s.x,s.y,0)),h.faces.push(new THREE.Face3(e*4,e*4+1,e*4+2)),h.faces.push(new THREE.Face3(e*4,e*4+2,e*4+3)),a.vertices.push(new THREE.Vector3(o.x,o.y,0)),a.vertices.push(new THREE.Vector3(o.x,o.y,-this.setting.Cal/2)),a.vertices.push(new THREE.Vector3(s.x,s.y,-this.setting.Cal/2)),a.vertices.push(new THREE.Vector3(s.x,s.y,0)),a.faces.push(new THREE.Face3(e*4,e*4+1,e*4+2)),a.faces.push(new THREE.Face3(e*4,e*4+2,e*4+3));for(g=[],d=!n.foldLine?new THREE.Vector3(0,0,0):new THREE.Vector3(n.foldLine.from.x,n.foldLine.from.y,0),e=0;e<h.faces.length;e++)g.push([h.vertices[h.faces[e].a].clone().add(d).findTexture(this.setting),h.vertices[h.faces[e].b].clone().add(d).findTexture(this.setting),h.vertices[h.faces[e].c].clone().add(d).findTexture(this.setting)]);h.faceVertexUvs[0]=g;h.computeFaceNormals();nt=new THREE.Mesh(h,u);tt=new THREE.Mesh(a,r);n.group.add(nt);n.group.add(tt);n.group.objFold=nt;n.group.objFold2=tt}n.changeAngle=function(){for(var i,t,n=0;n<y.length;n++)i=this.percent,t=new THREE.Vector3(y[n].to.x-y[n].from.x,y[n].to.y-y[n].from.y,0),t=t.normalize(),this.group.rotateOnAxis(t,this.percent)}},doFold:function(){this.percent+=this.percentDiff;this.percent>1&&(this.percent=1);this.doFoldOrExpond()},doExpond:function(){this.percent-=this.percentDiff;this.percent<0&&(this.percent=0);this.doFoldOrExpond()},doFoldOrExpond:function(){for(var t,i,n=0;n<this.planes.length;n++)this.planes[n].foldLine&&(i=this.planes[n].foldLine.getCurrentAngle(this.percent,Zw.MaxAngleStep),t=this.planes[n].group.$foldVector,t||(t=new THREE.Vector3,t.set(this.planes[n].foldLine.to.x-this.planes[n].foldLine.from.x,this.planes[n].foldLine.to.y-this.planes[n].foldLine.from.y,0).normalize(),this.planes[n].group.$foldVector=t),this.planes[n].group.rotation.set(0,0,0),this.planes[n].group.rotateOnAxis(t,i*Math.PI/180))},fixMesh:function(n,t,i){for(var u=n.geometry.vertices,r=0;r<u.length;r++)n.geometry.vertices[r]=new THREE.Vector3(u[r].x+t,u[r].y+i,u[r].z+0)},doReset:function(){this.percent=0;this.doFoldOrExpond();this.topMesh.position.set(0,0,0);this.topMesh.rotation.set(0,0,0)},genMaterial:function(n){return new THREE.MeshPhongMaterial({map:Zw.LoadCanvasTexture(Zw.factoryOfTextureAB.canvas,null,function(){Zw.__renderAB=Zw.__renderAB||0;Zw.__renderAB++},1),side:n,transparent:!0})},draw:function(){var n=this,t=new THREE.MeshPhongMaterial({map:Zw.LoadCanvasTexture(Zw.factoryOfTextureAB.canvasA,null,null,1),side:0,transparent:!0}),i=new THREE.MeshPhongMaterial({map:Zw.LoadCanvasTexture(Zw.factoryOfTextureAB.canvasB,null,null,1),side:1,transparent:!0}),r=new THREE.MeshPhongMaterial({map:t.map,side:THREE.DoubleSide,transparent:!0}),u=new THREE.MeshBasicMaterial({side:2,color:16316664}),f=new THREE.LineBasicMaterial({linewidth:1,color:10066346});return $.each(this.planes,function(t,i){i.setFaceVertexUvs(n.setting)}),$.each(this.planes,function(n,t){t.setGroupPostion()}),$.each(this.planes,function(e,o){n.drawOnePlane(o,t,i,u,r,f)}),this.topMesh.doFold=function(){n.doFold()},this.topMesh.doExpond=function(){n.doExpond()},this.topMesh.doReset=function(){n.doReset()},this.topMesh.doFoldOrExpond=function(){n.doFoldOrExpond()},this.topMesh.doChange=function(){n.doChange()},this.topMesh.autoFold=function(){(n.percent>=1||n.percent<=0)&&(n.isFold=!n.isFold);n.isFold?n.doFold():n.doExpond()},this.topMesh.getPercent=function(){return n.percent},this.topMesh.setPercent=function(t){return n.percent=t,n.topMesh},this.topMesh.moveToOrg=function(){this.position.set(this.setting.OffsetX,-this.setting.OffsetY,0)},this.topMesh.setting=n.setting,this.topMesh}};Zw.LoadTexture=function(n,t,i){var u=new THREE.LoadingManager,r=new THREE.Texture,f=new THREE.ImageLoader(u);return f.load(n,function(n){r.image=n;r.needsUpdate=!0;r.onUpdate=i;t&&t(r)}),r.minFilter=THREE.LinearFilter,r.magFilter=THREE.LinearFilter,r};Zw.LoadCanvasTexture=function(n,t,i){var r=new THREE.CanvasTexture(n);r.needsUpdate=!0;r.minFilter=THREE.LinearFilter;r.magFilter=THREE.LinearFilter;r.onUpdate=i;
//!noLog && console.log('%c LoadTexture by canvas', 'color:orange');
return t&&t(r),r};